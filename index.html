<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mod9 æ¤œç®—ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <style>
    /* ===== Reset & Base ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #fff;
      --primary: #1a1a1a;
      --blue: #a8d5e2;
      --green: #b8ddb0;
      --orange: #ffc09f;
      --text: #2b2b2b;
      --text-light: #6b6b6b;
      --border: #e8e8e8;
      --shadow: rgba(0, 0, 0, 0.08);
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
    }

    html, body {
      height: 100%;
      background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
      color: var(--text);
      font-family: var(--font);
      overflow-x: hidden;
    }

    /* ===== Layout ===== */
    #app {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== Header ===== */
    header {
      text-align: center;
      padding: 24px 0 16px;
      border-bottom: 3px solid var(--border);
    }

    header h1 {
      font-size: 2rem;
      color: var(--primary);
      font-weight: 800;
      letter-spacing: 2px;
    }

    header p {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 8px;
      font-weight: 500;
    }

    /* ===== Mode Tabs ===== */
    .tabs {
      display: flex;
      gap: 4px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .tab-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px 8px;
      background: #fff;
      color: var(--text-light);
      border: 2px solid var(--border);
      border-radius: 12px;
      font-family: var(--font);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }

    .tab-btn:hover {
      border-color: var(--blue);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .tab-btn.active {
      background: var(--blue);
      color: var(--primary);
      border-color: var(--blue);
      box-shadow: 0 6px 20px rgba(168, 213, 226, 0.4);
    }

    /* ===== Panels ===== */
    .panel {
      display: none;
      flex: 1;
      flex-direction: column;
    }

    .panel.active {
      display: flex;
    }

    /* ===== Question Display ===== */
    .question-area {
      text-align: center;
      padding: 24px 0;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .question-number {
      font-size: 2.8rem;
      color: var(--primary);
      font-weight: 800;
      letter-spacing: 8px;
      word-break: break-all;
    }

    .question-expr {
      font-size: 1.6rem;
      color: var(--text);
      font-weight: 700;
      letter-spacing: 2px;
      line-height: 1.6;
    }

    /* ===== Feedback ===== */
    .feedback {
      text-align: center;
      min-height: 40px;
      font-size: 1.2rem;
      padding: 8px;
      transition: opacity 0.3s;
    }

    .feedback.ok {
      color: var(--green);
      font-weight: 700;
    }

    .feedback.ng {
      color: var(--orange);
      font-weight: 700;
    }

    /* ===== Numpad ===== */
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      padding: 8px 0;
      max-width: 300px;
      margin: 0 auto;
      width: 100%;
    }

    .num-btn {
      padding: 20px 0;
      background: #fff;
      color: var(--primary);
      border: 2px solid var(--border);
      border-radius: 16px;
      font-family: var(--font);
      font-size: 1.4rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .num-btn:hover {
      background: var(--blue);
      border-color: var(--blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(168, 213, 226, 0.4);
      color: var(--primary);
    }

    .num-btn:active {
      background: var(--blue);
      transform: translateY(0);
      box-shadow: 0 2px 8px var(--shadow);
      color: var(--primary);
    }

    /* ===== Audit Buttons ===== */
    .audit-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      padding: 16px 0;
    }

    .audit-btn {
      padding: 16px 32px;
      font-family: var(--font);
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .audit-btn.pass {
      color: var(--primary);
      background: var(--green);
      border: 2px solid var(--green);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(184, 221, 176, 0.4);
    }

    .audit-btn.pass:hover {
      background: #a0c798;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(184, 221, 176, 0.5);
    }

    .audit-btn.error {
      color: var(--primary);
      background: var(--orange);
      border: 2px solid var(--orange);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(255, 192, 159, 0.4);
    }

    .audit-btn.error:hover {
      background: #f0ae87;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 192, 159, 0.5);
    }

    /* ===== Stats ===== */
    .stats {
      display: flex;
      justify-content: space-around;
      padding: 16px 0;
      border-top: 3px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-light);
      font-weight: 600;
    }

    .stats span {
      text-align: center;
    }

    .stats .value {
      display: block;
      font-size: 1.4rem;
      color: var(--primary);
      font-weight: 800;
    }

    /* ===== Time Attack ===== */
    .ta-controls {
      text-align: center;
      padding: 16px 0;
    }

    .ta-start-btn {
      padding: 16px 48px;
      background: var(--orange);
      color: var(--primary);
      border: none;
      border-radius: 24px;
      font-family: var(--font);
      font-size: 1.3rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 6px 20px rgba(255, 192, 159, 0.4);
    }

    .ta-start-btn:hover {
      background: #f0ae87;
      transform: translateY(-3px);
      box-shadow: 0 8px 28px rgba(255, 192, 159, 0.5);
    }

    .timer-bar {
      height: 8px;
      background: var(--border);
      margin: 12px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .timer-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--blue) 0%, var(--green) 100%);
      width: 100%;
      transition: width 0.1s linear;
      box-shadow: 0 0 12px rgba(168, 213, 226, 0.5);
    }

    .timer-display {
      text-align: center;
      font-size: 1.8rem;
      padding: 8px;
      color: var(--primary);
      font-weight: 800;
    }

    /* ===== Result Screen ===== */
    .result-screen {
      text-align: center;
      padding: 24px 0;
    }

    .result-screen h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: var(--primary);
      font-weight: 800;
    }

    .result-screen .score-line {
      font-size: 1.1rem;
      margin: 10px 0;
      color: var(--text-light);
      font-weight: 600;
    }

    .result-screen .score-line .value {
      color: var(--primary);
      font-size: 1.5rem;
      font-weight: 800;
    }

    .share-btn {
      display: inline-block;
      margin-top: 16px;
      padding: 12px 28px;
      background: var(--blue);
      color: var(--primary);
      border: none;
      border-radius: 16px;
      font-family: var(--font);
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(168, 213, 226, 0.4);
    }

    .share-btn:hover {
      background: #90c5d6;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168, 213, 226, 0.5);
    }

    .retry-btn {
      display: inline-block;
      margin-top: 12px;
      padding: 12px 28px;
      background: #fff;
      color: var(--primary);
      border: 2px solid var(--border);
      border-radius: 16px;
      font-family: var(--font);
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .retry-btn:hover {
      border-color: var(--blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* ===== Instructions ===== */
    .instructions {
      font-size: 0.85rem;
      color: var(--text-light);
      text-align: center;
      padding: 12px 16px;
      line-height: 1.8;
      background: rgba(168, 213, 226, 0.1);
      border-radius: 12px;
      margin: 8px 0;
    }

    .instructions strong {
      color: var(--primary);
      font-weight: 700;
    }

    /* ===== Footer ===== */
    footer {
      text-align: center;
      padding: 16px 0;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 3px solid var(--border);
      margin-top: auto;
      font-weight: 500;
    }

    /* ===== Responsive ===== */
    @media (max-width: 480px) {
      header h1 {
        font-size: 1.2rem;
        letter-spacing: 2px;
      }

      .question-number {
        font-size: 2.2rem;
        letter-spacing: 4px;
      }

      .question-expr {
        font-size: 1.2rem;
      }

      .num-btn {
        padding: 14px 0;
        font-size: 1.2rem;
      }

      .tab-btn {
        font-size: 0.7rem;
        padding: 8px 4px;
        min-width: 90px;
      }

      .audit-btn {
        padding: 14px 20px;
        font-size: 1rem;
      }
    }

    /* ===== Blink animation for cursor ===== */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .cursor-blink::after {
      content: 'â–ˆ';
      animation: blink 1s infinite;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header>
      <h1>MOD9 æ¤œç®—ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
    </header>

    <!-- Mode Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-mode="training">â–¶ Training</button>
      <button class="tab-btn" data-mode="audit">â–¶ Audit</button>
      <button class="tab-btn" data-mode="timeattack">â–¶ Time Attack</button>
    </div>

    <!-- ===== Training Panel ===== -->
    <div class="panel active" id="panel-training">
      <div class="instructions">
        <strong>[ Checksum Training ]</strong><br>
        è¡¨ç¤ºã•ã‚ŒãŸæ•°å­—ã®å„æ¡ã‚’è¶³ã—ã€1æ¡ã«ãªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã›ã€‚<br>
        ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ (0-9) ã§ã‚‚å…¥åŠ›å¯èƒ½ã€‚
      </div>
      <div class="question-area">
        <div class="question-number" id="training-question">---</div>
      </div>
      <div class="feedback" id="training-feedback">&nbsp;</div>
      <div class="numpad" id="training-numpad"></div>
      <div class="stats" id="training-stats">
        <span>æ­£è§£ <span class="value" id="training-correct">0</span></span>
        <span>å•é¡Œæ•° <span class="value" id="training-total">0</span></span>
        <span>æ­£ç­”ç‡ <span class="value" id="training-rate">--%</span></span>
      </div>
    </div>

    <!-- ===== Audit Panel ===== -->
    <div class="panel" id="panel-audit">
      <div class="instructions">
        <strong>[ Audit Mode ]</strong><br>
        æ›ã‘ç®—ã®å¼ãŒæ­£ã—ã„ã‹Mod9æ¤œç®—ã§åˆ¤å®šã›ã‚ˆã€‚<br>
        Mod9ãŒæ•´åˆãªã‚‰ Passã€ä¸æ•´åˆãªã‚‰ Errorã€‚
      </div>
      <div class="question-area">
        <div class="question-expr" id="audit-question">---</div>
      </div>
      <div class="feedback" id="audit-feedback">&nbsp;</div>
      <div class="audit-buttons">
        <button class="audit-btn pass" id="audit-pass">âœ… Pass</button>
        <button class="audit-btn error" id="audit-error">âŒ Error</button>
      </div>
      <div class="stats" id="audit-stats">
        <span>æ­£è§£ <span class="value" id="audit-correct">0</span></span>
        <span>å•é¡Œæ•° <span class="value" id="audit-total">0</span></span>
        <span>æ­£ç­”ç‡ <span class="value" id="audit-rate">--%</span></span>
      </div>
    </div>

    <!-- ===== Time Attack Panel ===== -->
    <div class="panel" id="panel-timeattack">
      <div class="instructions">
        <strong>[ Time Attack ]</strong><br>
        60ç§’é–“ã§ã§ãã‚‹ã ã‘å¤šãã®å•é¡Œã‚’è§£ã‘ï¼
      </div>

      <!-- Pre-game -->
      <div id="ta-pregame">
        <div class="ta-controls">
          <button class="ta-start-btn" id="ta-start">[ START ]</button>
        </div>
      </div>

      <!-- In-game -->
      <div id="ta-ingame" style="display:none;">
        <div class="timer-display" id="ta-timer">60.0</div>
        <div class="timer-bar"><div class="timer-bar-fill" id="ta-bar"></div></div>
        <div class="question-area">
          <div class="question-number" id="ta-question">---</div>
        </div>
        <div class="feedback" id="ta-feedback">&nbsp;</div>
        <div class="numpad" id="ta-numpad"></div>
        <div class="stats">
          <span>æ­£è§£ <span class="value" id="ta-correct">0</span></span>
          <span>å•é¡Œæ•° <span class="value" id="ta-total">0</span></span>
        </div>
      </div>

      <!-- Post-game -->
      <div id="ta-postgame" style="display:none;">
        <div class="result-screen">
          <h2>== RESULT ==</h2>
          <div class="score-line">æ­£è§£æ•°: <span class="value" id="ta-result-correct">0</span></div>
          <div class="score-line">å•é¡Œæ•°: <span class="value" id="ta-result-total">0</span></div>
          <div class="score-line">æ­£ç­”ç‡: <span class="value" id="ta-result-rate">0%</span></div>
          <div class="score-line">é€Ÿåº¦: <span class="value" id="ta-result-speed">0.00</span> checksums/sec</div>
          <br>
          <a class="share-btn" id="ta-share" href="#" target="_blank" rel="noopener noreferrer">ğŸ“¤ Xã§ã‚·ã‚§ã‚¢</a>
          <br>
          <button class="retry-btn" id="ta-retry">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      MOD9 DOJO v1.0 | GitHub Pages
    </footer>
  </div>

  <script>
    'use strict';

    // ===================================================================
    // Mod9 (Digital Root) è¨ˆç®—
    // ä¸ãˆã‚‰ã‚ŒãŸæ•´æ•°ã®Mod9ã‚’è¿”ã™ï¼ˆ0-8ã®ç¯„å›²ï¼‰
    // ===================================================================
    function mod9(n) {
      n = Math.abs(n);
      return n % 9;
    }

    // ===================================================================
    // ãƒ©ãƒ³ãƒ€ãƒ æ•´æ•°ç”Ÿæˆ (minä»¥ä¸Šmaxä»¥ä¸‹)
    // ===================================================================
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // ===================================================================
    // ãƒ©ãƒ³ãƒ€ãƒ ãª3ã€œ6æ¡ã®æ•´æ•°ã‚’ç”Ÿæˆ
    // ===================================================================
    function generateNumber() {
      const digits = randInt(3, 6);
      const min = Math.pow(10, digits - 1);
      const max = Math.pow(10, digits) - 1;
      return randInt(min, max);
    }

    // ===================================================================
    // ãƒ†ãƒ³ã‚­ãƒ¼ (3x3ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) ã‚’ç”Ÿæˆã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã«æŒ¿å…¥ã™ã‚‹
    // 1,2,3 / 4,5,6 / 7,8,0 ã®é…ç½®ï¼ˆé›»å“é¢¨ï¼‰
    // ===================================================================
    function createNumpad(container, callback) {
      container.innerHTML = '';
      // 3x3 ã®é…ç½®ï¼ˆé›»å“ãƒ»æºå¸¯é›»è©±é¢¨ï¼‰
      const keys = [1, 2, 3, 4, 5, 6, 7, 8, 0];
      keys.forEach(n => {
        const btn = document.createElement('button');
        btn.className = 'num-btn';
        // å³ä¸‹ã®ãƒœã‚¿ãƒ³ã¯0ã¨9ã®ä¸¡æ–¹ã‚’è¡¨ç¤º
        if (n === 0) {
          btn.textContent = '0 / 9';
          btn.setAttribute('data-num', '0');
          // 0ã¾ãŸã¯9ã®å…¥åŠ›ã‚’å‡¦ç†ï¼ˆmod9ã§ã¯0ã¨9ã¯åŒç­‰ï¼‰
          btn.addEventListener('click', () => callback(0));
        } else {
          btn.textContent = n;
          btn.setAttribute('data-num', n);
          btn.addEventListener('click', () => callback(n));
        }
        container.appendChild(btn);
      });
    }

    // ===================================================================
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
    // ===================================================================
    function showFeedback(el, isCorrect, message) {
      el.textContent = message;
      el.className = 'feedback ' + (isCorrect ? 'ok' : 'ng');
      // 1.2ç§’å¾Œã«ã‚¯ãƒªã‚¢
      clearTimeout(el._timer);
      el._timer = setTimeout(() => {
        el.innerHTML = '&nbsp;';
        el.className = 'feedback';
      }, 1200);
    }

    // ===================================================================
    // Mode Tabs
    // ===================================================================
    const tabButtons = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.panel');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        tabButtons.forEach(b => b.classList.remove('active'));
        panels.forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + mode).classList.add('active');

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯å®Ÿè¡Œä¸­ã«ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã—ãŸå ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
        if (mode !== 'timeattack' && taState.running) {
          stopTimeAttack();
        }
      });
    });

    // ===================================================================
    // Training Mode
    // ===================================================================
    const trainingState = { correct: 0, total: 0, currentNumber: 0 };

    const trainingQuestion = document.getElementById('training-question');
    const trainingFeedback = document.getElementById('training-feedback');
    const trainingNumpad = document.getElementById('training-numpad');
    const trainingCorrectEl = document.getElementById('training-correct');
    const trainingTotalEl = document.getElementById('training-total');
    const trainingRateEl = document.getElementById('training-rate');

    function newTrainingQuestion() {
      trainingState.currentNumber = generateNumber();
      trainingQuestion.textContent = trainingState.currentNumber.toLocaleString().replace(/,/g, ' ');
    }

    function answerTraining(n) {
      const correct = mod9(trainingState.currentNumber);
      trainingState.total++;
      if (n === correct) {
        trainingState.correct++;
        showFeedback(trainingFeedback, true, 'âœ” OK');
      } else {
        showFeedback(trainingFeedback, false, 'âœ˜ NG â€” æ­£è§£: ' + correct);
      }
      updateTrainingStats();
      newTrainingQuestion();
    }

    function updateTrainingStats() {
      trainingCorrectEl.textContent = trainingState.correct;
      trainingTotalEl.textContent = trainingState.total;
      trainingRateEl.textContent = trainingState.total > 0
        ? Math.round((trainingState.correct / trainingState.total) * 100) + '%'
        : '--%';
    }

    createNumpad(trainingNumpad, answerTraining);
    newTrainingQuestion();

    // ===================================================================
    // Audit Mode
    // ===================================================================
    const auditState = { correct: 0, total: 0, isCorrectAnswer: true };

    const auditQuestion = document.getElementById('audit-question');
    const auditFeedback = document.getElementById('audit-feedback');
    const auditPassBtn = document.getElementById('audit-pass');
    const auditErrorBtn = document.getElementById('audit-error');
    const auditCorrectEl = document.getElementById('audit-correct');
    const auditTotalEl = document.getElementById('audit-total');
    const auditRateEl = document.getElementById('audit-rate');

    /**
     * Auditç”¨ã®æ›ã‘ç®—å•é¡Œã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * isCorrect: true ãªã‚‰æ­£ã—ã„ç©ã€false ãªã‚‰Mod9ãŒã‚ºãƒ¬ãŸé–“é•ã„ç©ã‚’ç”Ÿæˆã€‚
     */
    function generateAuditQuestion() {
      const a = randInt(10, 999);
      const b = randInt(10, 999);
      const correctProduct = a * b;
      // 50%ã®ç¢ºç‡ã§æ­£ã—ã„ / é–“é•ã„ã‚’å‡ºã™
      const isCorrect = Math.random() < 0.5;

      let displayProduct;
      if (isCorrect) {
        displayProduct = correctProduct;
      } else {
        // Mod9ãŒç•°ãªã‚‹ã‚ˆã†ã«ç©ã‚’å¤‰æ›´ã™ã‚‹
        // æ­£ã—ã„ç©ã®Mod9ã‚’å–å¾—ã—ã€ãã‚Œã¨ã¯ç•°ãªã‚‹Mod9å€¤ã«ãªã‚‹ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’åŠ ç®—ã™ã‚‹
        const correctMod = mod9(correctProduct);
        let offset;
        let candidate;
        do {
          // Â±1ã€œÂ±æ•°ç™¾ã®ç¯„å›²ã§ãšã‚‰ã™
          offset = randInt(1, 100) * (Math.random() < 0.5 ? 1 : -1);
          candidate = correctProduct + offset;
        } while (candidate < 1 || mod9(candidate) === correctMod);
        displayProduct = candidate;
      }

      auditState.isCorrectAnswer = isCorrect;
      auditQuestion.textContent = a + ' Ã— ' + b + ' = ' + displayProduct;
    }

    function answerAudit(userSaysPass) {
      auditState.total++;
      const isUserCorrect = (userSaysPass === auditState.isCorrectAnswer);
      if (isUserCorrect) {
        auditState.correct++;
        showFeedback(auditFeedback, true, 'âœ” æ­£è§£!');
      } else {
        const reason = auditState.isCorrectAnswer ? 'å¼ã¯æ­£ã—ã‹ã£ãŸ' : 'å¼ã¯é–“é•ã„ã ã£ãŸ';
        showFeedback(auditFeedback, false, 'âœ˜ ä¸æ­£è§£ â€” ' + reason);
      }
      updateAuditStats();
      generateAuditQuestion();
    }

    function updateAuditStats() {
      auditCorrectEl.textContent = auditState.correct;
      auditTotalEl.textContent = auditState.total;
      auditRateEl.textContent = auditState.total > 0
        ? Math.round((auditState.correct / auditState.total) * 100) + '%'
        : '--%';
    }

    auditPassBtn.addEventListener('click', () => answerAudit(true));
    auditErrorBtn.addEventListener('click', () => answerAudit(false));
    generateAuditQuestion();

    // ===================================================================
    // Time Attack Mode
    // ===================================================================
    const TA_DURATION = 60; // ç§’
    const taState = {
      running: false,
      correct: 0,
      total: 0,
      currentNumber: 0,
      startTime: 0,
      timerId: null
    };

    const taPregame = document.getElementById('ta-pregame');
    const taIngame = document.getElementById('ta-ingame');
    const taPostgame = document.getElementById('ta-postgame');
    const taStartBtn = document.getElementById('ta-start');
    const taTimer = document.getElementById('ta-timer');
    const taBar = document.getElementById('ta-bar');
    const taQuestion = document.getElementById('ta-question');
    const taFeedback = document.getElementById('ta-feedback');
    const taNumpad = document.getElementById('ta-numpad');
    const taCorrectEl = document.getElementById('ta-correct');
    const taTotalEl = document.getElementById('ta-total');
    const taResultCorrect = document.getElementById('ta-result-correct');
    const taResultTotal = document.getElementById('ta-result-total');
    const taResultRate = document.getElementById('ta-result-rate');
    const taResultSpeed = document.getElementById('ta-result-speed');
    const taShareLink = document.getElementById('ta-share');
    const taRetryBtn = document.getElementById('ta-retry');

    function newTaQuestion() {
      taState.currentNumber = generateNumber();
      taQuestion.textContent = taState.currentNumber.toLocaleString().replace(/,/g, ' ');
    }

    function answerTimeAttack(n) {
      if (!taState.running) return;
      const correct = mod9(taState.currentNumber);
      taState.total++;
      if (n === correct) {
        taState.correct++;
        showFeedback(taFeedback, true, 'âœ”');
      } else {
        showFeedback(taFeedback, false, 'âœ˜ ' + correct);
      }
      taCorrectEl.textContent = taState.correct;
      taTotalEl.textContent = taState.total;
      newTaQuestion();
    }

    function startTimeAttack() {
      taState.running = true;
      taState.correct = 0;
      taState.total = 0;
      taState.startTime = Date.now();
      taCorrectEl.textContent = '0';
      taTotalEl.textContent = '0';

      taPregame.style.display = 'none';
      taPostgame.style.display = 'none';
      taIngame.style.display = 'block';

      newTaQuestion();

      // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–° (100msæ¯)
      taState.timerId = setInterval(() => {
        const elapsed = (Date.now() - taState.startTime) / 1000;
        const remaining = Math.max(0, TA_DURATION - elapsed);
        taTimer.textContent = remaining.toFixed(1);
        taBar.style.width = ((remaining / TA_DURATION) * 100) + '%';

        if (remaining <= 0) {
          stopTimeAttack();
        }
      }, 100);
    }

    function stopTimeAttack() {
      taState.running = false;
      clearInterval(taState.timerId);
      taIngame.style.display = 'none';
      taPostgame.style.display = 'block';

      const rate = taState.total > 0
        ? Math.round((taState.correct / taState.total) * 100) + '%'
        : '0%';
      const speed = (taState.correct / TA_DURATION).toFixed(2);

      taResultCorrect.textContent = taState.correct;
      taResultTotal.textContent = taState.total;
      taResultRate.textContent = rate;
      taResultSpeed.textContent = speed;

      // Xã‚·ã‚§ã‚¢ãƒªãƒ³ã‚¯ä½œæˆ
      const text = encodeURIComponent(
        'ã€MOD9 DOJOã€‘Time Attack Result\n' +
        'æ­£è§£: ' + taState.correct + '/' + taState.total + '\n' +
        'æ­£ç­”ç‡: ' + rate + '\n' +
        'é€Ÿåº¦: ' + speed + ' checksums/sec\n' +
        '#Mod9Dojo #ä¹å»æ³•'
      );
      taShareLink.href = 'https://x.com/intent/tweet?text=' + text;
    }

    createNumpad(taNumpad, answerTimeAttack);
    taStartBtn.addEventListener('click', startTimeAttack);
    taRetryBtn.addEventListener('click', () => {
      taPostgame.style.display = 'none';
      taPregame.style.display = 'block';
    });

    // ===================================================================
    // Keyboard Support (0-9 ã‚­ãƒ¼å…¥åŠ›)
    // ===================================================================
    document.addEventListener('keydown', (e) => {
      const key = e.key;
      const activePanel = document.querySelector('.panel.active');

      // æ•°å­—ã‚­ãƒ¼ 0-9
      if (key >= '0' && key <= '9') {
        const num = parseInt(key, 10);
        // mod9ã§ã¯0ã¨9ã¯åŒã˜
        const normalizedNum = num % 9;
        // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‘ãƒãƒ«ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
        if (activePanel.id === 'panel-training') {
          answerTraining(normalizedNum);
        } else if (activePanel.id === 'panel-timeattack' && taState.running) {
          answerTimeAttack(normalizedNum);
        }
      }

      // Audit Modeç”¨: P=Pass, E=Error
      if (activePanel.id === 'panel-audit') {
        if (key === 'p' || key === 'P') {
          answerAudit(true);
        } else if (key === 'e' || key === 'E') {
          answerAudit(false);
        }
      }
    });
  </script>
</body>
</html>
